name: MacOS Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
      env:
        PIP_DISABLE_PIP_VERSION_CHECK: "1"

    - name: Build with PyInstaller (Onedir Mode)
      run: |
        pyinstaller --noconfirm --onedir --windowed --name "FermiSimulator" \
          --add-data "data:data" \
          --add-data "src:src" \
          --hidden-import "matplotlib.backends.backend_svg" \
          --hidden-import "matplotlib.backends.backend_pdf" \
          --hidden-import "xraylib" \
          --hidden-import "src.simulator" \
          --hidden-import "src.translations" \
          --hidden-import "src.material" \
          --hidden-import "src.physics" \
          --hidden-import "src.field_solver" \
          --hidden-import "src.monte_carlo" \
          src/gui.py

    - name: Fix Qt plugin paths and inject qt.conf
      run: |
        APP="dist/FermiSimulator.app"
        PLUG_SRC="$APP/Contents/Frameworks/PyQt6/Qt6/plugins"
        PLUG_DST="$APP/Contents/PlugIns"
        RES_DIR="$APP/Contents/Resources"

        mkdir -p "$PLUG_DST"
        if [ -d "$PLUG_SRC" ]; then
          rsync -a "$PLUG_SRC/" "$PLUG_DST/" || cp -R "$PLUG_SRC/" "$PLUG_DST/"
        fi

        mkdir -p "$RES_DIR"
        cat > "$RES_DIR/qt.conf" << 'EOF'
        [Paths]
        Plugins = PlugIns
        EOF

        echo "Qt plugins placed at: $PLUG_DST"
        ls -al "$PLUG_DST" || true

    - name: Create DMG with Instructions
      run: |
        # Create a temporary directory for DMG content
        mkdir -p dist/dmg_content
        cp -r "dist/FermiSimulator.app" dist/dmg_content/
        
        # Create a symlink to Applications folder
        ln -s /Applications dist/dmg_content/Applications
        
        # Create a friendly README for users
        cat > "dist/dmg_content/INSTALL_NOTE.txt" << 'EOF'
        === IMPORTANT INSTALLATION INSTRUCTIONS ===

        1. Drag "FermiSimulator.app" to the "Applications" folder.
        
        2. IF THE APP CRASHES OR SAYS "DAMAGED":
           This is a common security check for unsigned open-source apps on macOS.
           
           Please run this command in Terminal to fix it:
           
           xattr -cr /Applications/FermiSimulator.app
           
           (This removes the quarantine attribute that blocks unsigned apps)

        3. Then open the app normally.
        ===========================================
        EOF
        
        # Create DMG using native hdiutil
        hdiutil create -volname "FermiSimulator Installer" \
          -srcfolder dist/dmg_content \
          -ov -format UDZO \
          "dist/FermiSimulator.dmg"

    - name: Upload Artifact (DMG)
      uses: actions/upload-artifact@v4
      with:
        name: FermiSimulator-macOS-DMG
        path: dist/FermiSimulator.dmg

    - name: Upload Artifact (APP)
      uses: actions/upload-artifact@v4
      with:
        name: FermiSimulator-macOS-APP
        path: dist/FermiSimulator.app
